<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>í‘¸ë“œë¦¿ì§€ ë°œì£¼ì„œ</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 10px;
      -webkit-tap-highlight-color: transparent;
    }
    .container { max-width: 680px; margin: 0 auto; background: #fff; border-radius: 16px; box-shadow: 0 18px 36px rgba(0,0,0,.15); overflow: hidden; }
    .header { background: linear-gradient(135deg, #4CAF50 0%, #22c55e 100%); color:#fff; padding: 18px 20px; text-align:center; }
    .header h1 { font-size: 1.35rem; font-weight: 800; letter-spacing: .02em; }
    .content { padding: 18px; }
    .section { margin-bottom: 22px; }
    .section-title { font-size: 1.05rem; font-weight: 800; color:#0f172a; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #f1f5f9; }
    .form-group { margin-bottom: 12px; }
    .form-group label { display:block; font-size:.9rem; font-weight:700; color:#334155; margin-bottom:6px; }
    .form-group input, .form-group select, .form-group textarea {
      width:100%; padding:12px 14px; border:2px solid #e2e8f0; border-radius: 10px; font-size: 1rem; transition: box-shadow .2s, border-color .2s;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline:none; border-color:#22c55e; box-shadow: 0 0 0 4px rgba(34,197,94,.15);
    }
    .warehouse-section { background:#f8fafc; border:1px solid #e2e8f0; border-radius:12px; padding:12px; margin-bottom:10px; }
    .warehouse-title { font-weight:800; color:#0f172a; display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:8px; }
    .warehouse-code { font-size: .75rem; padding: 2px 8px; border-radius:9999px; background:#10b981; color:#fff; font-weight:800; }
    .product-item { display:flex; align-items:center; gap:10px; background:#fff; border-radius:10px; padding:10px; margin-top:8px; box-shadow: 0 1px 3px rgba(2,6,23,.06); }
    .product-item input[type="checkbox"] { width:22px; height:22px; accent-color:#22c55e; }
    .product-info { flex:1; min-width:0; }
    .product-code { font-size:.9rem; font-weight:900; color:#0f172a; }
    .product-name { font-size:.85rem; color:#475569; margin-top:2px; }
    .quantity { display:flex; align-items:center; gap:6px; }
    .quantity-input { width:90px; padding:10px 12px; text-align:center; border:2px solid #e2e8f0; border-radius:10px; font-size:1rem; }
    .summary-grid { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .summary-item { background:#f8fafc; border:1px solid #e2e8f0; border-radius:10px; padding:12px; text-align:center; }
    .summary-item .label { font-size:.8rem; color:#64748b; }
    .summary-item .value { font-size:1.25rem; font-weight:900; color:#0f172a; }
    .total-summary { grid-column: span 2; background:linear-gradient(135deg,#22c55e,#16a34a); color:#fff; border:none; }
    .total-summary .value { color:#fff; }
    .buttons { display:flex; gap:10px; margin-top:12px; }
    .btn { flex:1; padding:14px; border:none; border-radius:12px; font-weight:800; letter-spacing:.02em; cursor:pointer; box-shadow: 0 6px 14px rgba(2,6,23,.15); }
    .btn-secondary { background:#0ea5e9; color:#fff; }
    .btn-primary { background:#16a34a; color:#fff; }
    .required { color:#ef4444; }
    .delivery-notice { background:#fef3c7; border:1px solid #f59e0b; border-radius:10px; padding:12px; margin-top:12px; }
    .delivery-notice-icon { font-size:1.2rem; }
    .delivery-notice-title { font-weight:700; color:#92400e; font-size:.9rem; margin-bottom:6px; }
    .delivery-notice-content { color:#92400e; font-size:.85rem; line-height:1.4; }
    .modal { display:none; position:fixed; inset:0; z-index:1000; background:rgba(0,0,0,.5); }
    .modal-content { width:min(92%, 520px); max-height:82vh; overflow:auto; background:#fff; margin: 7vh auto; border-radius:16px; padding:18px; }
    .modal-header { display:flex; align-items:center; justify-content:space-between; padding-bottom:10px; border-bottom:1px solid #e2e8f0; }
    .close { font-size:28px; font-weight:800; color:#94a3b8; cursor:pointer; }
    @media (max-width:480px) {
      .container { border-radius: 0; }
      .buttons { flex-direction: column; }
      .summary-grid { grid-template-columns: 1fr; }
      .total-summary { grid-column: span 1; }
    }
    input, select, textarea { font-size:16px; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ½ï¸ í‘¸ë“œë¦¿ì§€ ë°œì£¼ì„œ</h1>
    </div>

    <div class="content">
      <form id="orderForm" novalidate>
        <!-- ê¸°ë³¸ ì •ë³´ -->
        <div class="section">
          <h3 class="section-title">ğŸ“‹ ê¸°ë³¸ ì •ë³´</h3>

          <div class="form-group">
            <label>ë°œì£¼ë²ˆí˜¸ (ê³ ê°ì´ ì›í•  ê²½ìš° ìˆ˜ì • ê°€ëŠ¥)</label>
            <input type="text" id="orderNumber" placeholder="ìë™ ìƒì„±ë©ë‹ˆë‹¤">
          </div>

          <div class="form-group">
            <label>ê³ ê° ìœ í˜• <span class="required">*</span></label>
            <select id="customerType" required>
              <option value="">ì„ íƒí•˜ì„¸ìš”</option>
              <option value="existing-same">ê¸°ì¡´ ê³ ê° (ê¸°ì¡´ ë°°ì†¡ì§€)</option>
              <option value="existing-different">ê¸°ì¡´ ê³ ê° (ë‹¤ë¥¸ ë°°ì†¡ì§€)</option>
              <option value="new">ì‹ ê·œ ê³ ê°</option>
            </select>
          </div>

          <div class="form-group">
            <label>ê³ ê°ì‚¬ëª… <span class="required">*</span></label>
            <input type="text" id="companyName" required placeholder="íšŒì‚¬ëª…">
          </div>

          <div class="form-group">
            <label>ë‹´ë‹¹ì ì´ë¦„ <span class="required">*</span></label>
            <input type="text" id="contactName" required placeholder="ë‹´ë‹¹ìëª…">
          </div>

          <div class="form-group">
            <label>ì—°ë½ì²˜ <span class="required">*</span></label>
            <input type="tel" id="contactPhone" required placeholder="010-0000-0000">
          </div>

          <div class="form-group">
            <label>ì´ë©”ì¼ <span class="required">*</span></label>
            <input type="email" id="email" required placeholder="name@company.com">
          </div>

          <div class="form-group" id="addressGroup">
            <label>ë°°ì†¡ì£¼ì†Œ <span class="required">*</span></label>
            <input type="text" id="deliveryAddress" required placeholder="ì‹œ/êµ°/êµ¬, ìƒì„¸ì£¼ì†Œ">
          </div>
        </div>

        <!-- ì œí’ˆ ì„ íƒ -->
        <div class="section">
          <h3 class="section-title">ğŸ“¦ ì œí’ˆ ì„ íƒ</h3>

          <!-- ì´ì²œ ì°½ê³  -->
          <div class="warehouse-section">
            <div class="warehouse-title">
              <span>ğŸ­ ì´ì²œ ì°½ê³  (ìºë‚˜ë‹¤ ê³„ë€ë¥˜) ë¶€ê°€ì„¸ ë©´ì„¸ ìƒí’ˆ</span>
              <span class="warehouse-code">ICN</span>
            </div>

            <div class="product-item">
              <input type="checkbox" id="prod-5113">
              <div class="product-info">
                <div class="product-code">5113</div>
                <div class="product-name">ìºë‚˜ë‹¤ ëƒ‰ë™ ë‚œë°± 2kgÃ—6íŒ©</div>
              </div>
              <div class="quantity">
                <input type="number" class="quantity-input" id="qty-5113" min="0" inputmode="numeric" placeholder="0">
                <span>ë°•ìŠ¤</span>
              </div>
            </div>

            <div class="product-item">
              <input type="checkbox" id="prod-5313">
              <div class="product-info">
                <div class="product-code">5313</div>
                <div class="product-name">ìºë‚˜ë‹¤ ëƒ‰ë™ ì „ë€ 2kgÃ—6íŒ©</div>
              </div>
              <div class="quantity">
                <input type="number" class="quantity-input" id="qty-5313" min="0" inputmode="numeric" placeholder="0">
                <span>ë°•ìŠ¤</span>
              </div>
            </div>

            <div class="product-item">
              <input type="checkbox" id="prod-5270">
              <div class="product-info">
                <div class="product-code">5270</div>
                <div class="product-name">ìºë‚˜ë‹¤ ëƒ‰ë™ ë‚œí™© 2kgÃ—6íŒ©</div>
              </div>
              <div class="quantity">
                <input type="number" class="quantity-input" id="qty-5270" min="0" inputmode="numeric" placeholder="0">
                <span>ë°•ìŠ¤</span>
              </div>
            </div>

            <div class="product-item">
              <input type="checkbox" id="prod-5139">
              <div class="product-info">
                <div class="product-code">5139</div>
                <div class="product-name">ìºë‚˜ë‹¤ ëƒ‰ë™ ìŠˆí¼íœ© 1kgÃ—12íŒ©</div>
              </div>
              <div class="quantity">
                <input type="number" class="quantity-input" id="qty-5139" min="0" inputmode="numeric" placeholder="0">
                <span>ë°•ìŠ¤</span>
              </div>
            </div>
          </div>

          <!-- ì•ˆì„± ì°½ê³  -->
          <div class="warehouse-section">
            <div class="warehouse-title">
              <span>ğŸ­ ì•ˆì„± ì°½ê³  (SQIZ ê°ì) ë¶€ê°€ì„¸ ì ìš© ìƒí’ˆ</span>
              <span class="warehouse-code">ASG</span>
            </div>

            <div class="product-item">
              <input type="checkbox" id="prod-fr02001">
              <div class="product-info">
                <div class="product-code">FR02001</div>
                <div class="product-name">SQIZ 9MM ì½”íŒ… ìŠ¤í‚¨ì˜¤í”„ ê°ì 2kgÃ—6íŒ©</div>
              </div>
              <div class="quantity">
                <input type="number" class="quantity-input" id="qty-fr02001" min="0" step="40" inputmode="numeric" placeholder="0 (â†‘ 40ë‹¨ìœ„ / â†“ 1ë‹¨ìœ„)">
                <span>ë°•ìŠ¤</span>
              </div>
            </div>
          </div>
        </div>

        <!-- ì£¼ë¬¸ ìš”ì•½ -->
        <div class="section">
          <h3 class="section-title">ğŸ“Š ì£¼ë¬¸ ìš”ì•½</h3>
          <div class="summary-grid">
            <div class="summary-item">
              <div class="label">ì´ì²œì°½ê³ </div>
              <div class="value" id="icnTotal">0ë°•ìŠ¤</div>
            </div>
            <div class="summary-item">
              <div class="label">ì•ˆì„±ì°½ê³ </div>
              <div class="value" id="asgTotal">0ë°•ìŠ¤</div>
            </div>
            <div class="summary-item total-summary">
              <div class="label">ì´ ì£¼ë¬¸ëŸ‰</div>
              <div class="value" id="grandTotal">0ë°•ìŠ¤</div>
            </div>
          </div>
        </div>

        <!-- ë°°ì†¡ ì •ë³´ -->
        <div class="section">
          <h3 class="section-title">ğŸšš ë°°ì†¡ ì •ë³´</h3>

          <div class="form-group">
            <label>ë°°ì†¡ ë°©ë²• <span class="required">*</span></label>
            <select id="deliveryMethod" required>
              <option value="">ì„ íƒí•˜ì„¸ìš”</option>
              <option value="delivery">ë°°ì†¡ ìš”ì²­</option>
              <option value="pickup">ì°½ê³  í”½ì—…</option>
            </select>
          </div>

          <div class="form-group">
            <label>ë°°ì†¡ìš”ì²­ì¼ ë˜ëŠ” í”½ì—…í¬ë§ì¼ <span class="required">*</span></label>
            <input type="date" id="deliveryDate" required>
          </div>

          <!-- ì•ˆì„± + ë°°ì†¡ìš”ì²­ì¼ ë•Œë§Œ -->
          <div class="form-group hidden" id="requestTypeGroup">
            <label>ì¶œê³  ë°©ì‹ (ì•ˆì„±ì°½ê³  + ë°°ì†¡ ìš”ì²­ ì‹œ)</label>
            <select id="requestType">
              <option value="íŒ”ë ˆíŠ¸ ì¶œê³ " selected>íŒ”ë ˆíŠ¸ ì¶œê³ </option>
              <option value="ìˆ˜ì‘ì—… ì¶œê³ ">ìˆ˜ì‘ì—… ì¶œê³ </option>
            </select>
          </div>

          <div class="form-group">
            <label>ìš”ì²­ì‚¬í•­</label>
            <textarea id="requests" rows="2" placeholder="ì˜ˆ: 10~12ì‹œ í¬ë§, ê¸°ì‚¬ë‹˜ ì—°ë½ ìš”ë§ ë“±"></textarea>
          </div>

          <div class="delivery-notice">
            <div style="display:flex; align-items:flex-start; gap:8px;">
              <span class="delivery-notice-icon">âš ï¸</span>
              <div>
                <div class="delivery-notice-title">ë°°ì†¡ ì•ˆë‚´ì‚¬í•­</div>
                <div class="delivery-notice-content">
                  â€¢ <strong>ì´ì²œì°½ê³ </strong>ì™€ <strong>ì•ˆì„±ì°½ê³ </strong> ì œí’ˆì€ <strong>í•©ë°°ì†¡ì´ ë¶ˆê°€</strong>í•©ë‹ˆë‹¤.<br>
                  â€¢ ë‘ ì°½ê³  ì œí’ˆì„ í•¨ê»˜ ì£¼ë¬¸í•˜ì‹¤ ê²½ìš° ë³„ë„ ë°°ì†¡ë©ë‹ˆë‹¤.<br>
                  â€¢ ê°ê° MOQë¥¼ ìœ ì§€í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="buttons">
          <button type="button" class="btn btn-secondary" id="btnReview">ì£¼ë¬¸ë‚´ìš© í™•ì¸</button>
          <button type="submit" class="btn btn-primary" id="btnSubmit">ë°œì£¼ì„œ ì œì¶œ</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ëª¨ë‹¬ -->
  <div id="orderModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">ğŸ“‹ ì£¼ë¬¸ë‚´ìš© í™•ì¸</h3>
        <span class="close" id="modalClose" aria-label="ë‹«ê¸°">&times;</span>
      </div>
      <div id="orderSummaryContent" style="line-height:1.6;"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <script>
    const EmailClient = {
      _ready:false,
      init(publicKey){
        try{
          if(window.emailjs && typeof window.emailjs.init === 'function'){
            window.emailjs.init(publicKey);
            this._ready = true;
          } else {
            console.warn('EmailJS not available; will fall back to mailto.');
          }
        }catch(e){ console.warn('EmailJS init failed:', e); }
      },
      send(serviceId, templateId, params){
        if(this._ready && window.emailjs && typeof window.emailjs.send === 'function'){
          return window.emailjs.send(serviceId, templateId, params);
        } else {
          const to = encodeURIComponent('order@foodridge.co.kr');
          const subject = encodeURIComponent('[í‘¸ë“œë¦¿ì§€] ì‹ ê·œ ë°œì£¼ì„œ ì œì¶œ - ' + (params.order_number || ''));
          const body = encodeURIComponent(params.__plain || 'ë°œì£¼ ë‚´ì—­ì´ ì²¨ë¶€ë©ë‹ˆë‹¤.');
          window.location.href = `mailto:${to}?subject=${subject}&body=${body}`;
          return Promise.resolve();
        }
      }
    };

    const EMAILJS_PUBLIC_KEY = "uShz4QaVUzFOJMOZs";
    const EMAILJS_SERVICE_ID = "service_24b5nff";
    const FOODRIDGE_TEMPLATE_ID = "template_4wmwxm2";
    const CUSTOMER_TEMPLATE_ID = "template_fg3wre7";
    EmailClient.init(EMAILJS_PUBLIC_KEY);

    const $ = (id) => document.getElementById(id);
    const todayISO = () => (new Date()).toISOString().split('T')[0];

    $('deliveryDate').min = todayISO();
    function generateOrderNumber() {
      const now = new Date();
      return `F${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}-${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;
    }
    $('orderNumber').value = generateOrderNumber();

    const ICN = ['5113','5313','5270','5139'];
    const ASG = ['fr02001'];

    function parseQty(v) {
      const n = parseInt(String(v).replace(/[^0-9]/g,''), 10);
      return isNaN(n) ? 0 : n;
    }

    function hasASGSelected(){
      return ASG.some(id => {
        const cb = $('prod-' + id);
        const qty = parseQty(($('qty-' + id) || {}).value);
        return cb && cb.checked && qty > 0;
      });
    }

    function updateTotals() {
      let icn = 0, asg = 0;
      ICN.forEach(id => {
        const cb = $('prod-' + id);
        const qty = parseQty(($('qty-' + id) || {}).value);
        if (cb && cb.checked && qty > 0) icn += qty;
      });
      ASG.forEach(id => {
        const cb = $('prod-' + id);
        const qty = parseQty(($('qty-' + id) || {}).value);
        if (cb && cb.checked && qty > 0) asg += qty;
      });
      $('icnTotal').textContent = icn + 'ë°•ìŠ¤';
      $('asgTotal').textContent = asg + 'ë°•ìŠ¤';
      $('grandTotal').textContent = (icn + asg) + 'ë°•ìŠ¤';
      toggleRequestType();
    }

    function wireQtySync() {
      const all = [...ICN, ...ASG];
      all.forEach(id => {
        const cb = $('prod-' + id);
        const qty = $('qty-' + id);
        if (!cb || !qty) return;

        cb.addEventListener('change', () => {
          if (cb.checked) {
            const isASG = ASG.includes(id);
            const defaultVal = isASG ? 40 : 1;
            if (!qty.value || parseQty(qty.value) === 0) qty.value = String(defaultVal);
          } else {
            qty.value = '';
          }
          updateTotals();
        }, {passive: true});

        const onQtyChange = () => {
          const val = parseQty(qty.value);
          cb.checked = val > 0;
          qty.value = val > 0 ? String(val) : '';
          updateTotals();
        };
        ['input','change','keyup','blur'].forEach(evt => qty.addEventListener(evt, onQtyChange, {passive:true}));
      });
    }

    function applyASGStepSmart() {
      ASG.forEach(id => {
        const qty = $('qty-' + id);
        if (!qty) return;

        qty.setAttribute('min','0');
        qty.setAttribute('step','40');
        qty.setAttribute('inputmode','numeric');
        qty.placeholder = '0 (â†‘ 40ë‹¨ìœ„ / â†“ 1ë‹¨ìœ„)';

        let last = parseQty(qty.value);

        qty.addEventListener('focus', () => { last = parseQty(qty.value); });

        qty.addEventListener('keydown', (e) => {
          let current = parseQty(qty.value);
          if (isNaN(current)) current = 0;

          if (e.key === 'ArrowUp') {
            e.preventDefault();
            const next = Math.max(40, (Math.floor(current / 40) + 1) * 40);
            qty.value = String(next);
            last = next;
            qty.dispatchEvent(new Event('input', {bubbles:true}));
          } else if (e.key === 'ArrowDown') {
            e.preventDefault();
            const next = Math.max(0, current - 1);
            qty.value = String(next);
            last = next;
            qty.dispatchEvent(new Event('input', {bubbles:true}));
          }
        });

        qty.addEventListener('input', (e) => {
          const inputType = e.inputType || '';
          const isTyping = inputType.startsWith('insertText') || inputType.startsWith('delete');

          let current = parseQty(qty.value);
          if (isTyping) {
            last = current;
            return;
          }

          if (current > last) {
            const snapped = Math.max(40, Math.ceil(current / 40) * 40);
            if (snapped !== current) {
              qty.value = String(snapped);
              current = snapped;
            }
          } else if (current < last) {
            const snapped = Math.max(0, last - 1);
            if (snapped !== current) {
              qty.value = String(snapped);
              current = snapped;
            }
          }
          last = current;
        });
      });
    }

    function toggleRequestType() {
      const dm = $('deliveryMethod').value;
      const group = $('requestTypeGroup');
      const sel = $('requestType');
      if (dm === 'delivery' && hasASGSelected()) {
        group.classList.remove('hidden');
        sel.value = 'íŒ”ë ˆíŠ¸ ì¶œê³ ';
      } else {
        group.classList.add('hidden');
        sel.value = '';
      }
    }

    function showOrderSummary() {
      let html = '';
      html += `<p><strong>ë°œì£¼ë²ˆí˜¸:</strong> ${$('orderNumber').value || 'ìë™ ìƒì„±ë©ë‹ˆë‹¤'}</p>`;
      html += `<p><strong>ê³ ê°ì‚¬:</strong> ${$('companyName').value}</p>`;
      html += `<p><strong>ë‹´ë‹¹ì:</strong> ${$('contactName').value}</p>`;
      html += `<p><strong>ì—°ë½ì²˜:</strong> ${$('contactPhone').value}</p>`;
      html += `<p><strong>ì´ë©”ì¼:</strong> ${$('email').value}</p>`;
      html += `<p><strong>ë°°ì†¡ì£¼ì†Œ:</strong> ${$('deliveryAddress').value}</p>`;

      html += '<h4 style="margin:14px 0 6px; color:#16a34a">ğŸ“¦ ì„ íƒ ì œí’ˆ</h4>';
      const list = [];
      const P = [
        {id:'5113', name:'ìºë‚˜ë‹¤ ëƒ‰ë™ ë‚œë°± 2kgÃ—6íŒ©', wh:'ì´ì²œ'},
        {id:'5313', name:'ìºë‚˜ë‹¤ ëƒ‰ë™ ì „ë€ 2kgÃ—6íŒ©', wh:'ì´ì²œ'},
        {id:'5270', name:'ìºë‚˜ë‹¤ ëƒ‰ë™ ë‚œí™© 2kgÃ—6íŒ©', wh:'ì´ì²œ'},
        {id:'5139', name:'ìºë‚˜ë‹¤ ëƒ‰ë™ ìŠˆí¼íœ© 1kgÃ—12íŒ©', wh:'ì´ì²œ'},
        {id:'fr02001', name:'SQIZ 9MM ì½”íŒ… ìŠ¤í‚¨ì˜¤í”„ ê°ì 2kgÃ—6íŒ©', wh:'ì•ˆì„±'}
      ];
      P.forEach(p => {
        const cb = $('prod-' + p.id);
        const q = parseQty(($('qty-' + p.id) || {}).value);
        if (cb && cb.checked && q > 0) {
          list.push(`â€¢ [${p.wh}] ${p.id} - ${p.name}: <strong>${q}ë°•ìŠ¤</strong>`);
        }
      });
      html += list.length ? `<div>${list.join('<br>')}</div>` : `<p style="color:#ef4444">ì„ íƒëœ ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>`;

      html += '<h4 style="margin:14px 0 6px; color:#16a34a">ğŸšš ë°°ì†¡ ì •ë³´</h4>';
      const dm = $('deliveryMethod');
      const dmText = dm.options[dm.selectedIndex]?.text || 'ë¯¸ì„ íƒ';
      html += `<p><strong>ë°°ì†¡ë°©ë²•:</strong> ${dmText}</p>`;
      html += `<p><strong>í¬ë§ì¼:</strong> ${$('deliveryDate').value || 'ë¯¸ì„ íƒ'}</p>`;
      if ($('deliveryMethod').value === 'delivery' && hasASGSelected()) {
        const rt = $('requestType').value || 'íŒ”ë ˆíŠ¸ ì¶œê³ ';
        html += `<p><strong>ì¶œê³  ë°©ì‹:</strong> ${rt}</p>`;
      }
      if ($('requests').value) html += `<p><strong>ìš”ì²­ì‚¬í•­:</strong> ${$('requests').value}</p>`;

      $('orderSummaryContent').innerHTML = html;
      $('orderModal').style.display = 'block';
    }

    function closeModal() { $('orderModal').style.display = 'none'; }

    function handleSubmit(e) {
      e.preventDefault();
      const required = ['customerType','companyName','contactName','contactPhone','email','deliveryAddress','deliveryMethod','deliveryDate'];
      let ok = true;
      required.forEach(id => {
        const el = $(id);
        if (!el || !String(el.value || '').trim()) {
          el && (el.style.borderColor = '#ef4444');
          ok = false;
        } else {
          el.style.borderColor = '#e2e8f0';
        }
      });

      const products = [];
      const P = [
        {id:'5113', label:'[ì´ì²œ] 5113 ìºë‚˜ë‹¤ ëƒ‰ë™ ë‚œë°± (2kgÃ—6)'},
        {id:'5313', label:'[ì´ì²œ] 5313 ìºë‚˜ë‹¤ ëƒ‰ë™ ì „ë€ (2kgÃ—6)'},
        {id:'5270', label:'[ì´ì²œ] 5270 ìºë‚˜ë‹¤ ëƒ‰ë™ ë‚œí™© (2kgÃ—6)'},
        {id:'5139', label:'[ì´ì²œ] 5139 ìºë‚˜ë‹¤ ëƒ‰ë™ ìŠˆí¼íœ© (1kgÃ—12)'},
        {id:'fr02001', label:'[ì•ˆì„±] FR02001 SQIZ 9MM ì½”íŒ… ìŠ¤í‚¨ì˜¤í”„ ê°ì (2kgÃ—6)'}
      ];
      P.forEach(p => {
        const cb = $('prod-' + p.id);
        const q = parseQty(($('qty-' + p.id) || {}).value);
        if (cb && cb.checked && q > 0) products.push(`${p.label}: ${q}ë°•ìŠ¤`);
      });
      if (!products.length) { alert('ìµœì†Œ 1ê°œ ì´ìƒì˜ ì œí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); ok = false; }
      if (!ok) { alert('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

      const icn = $('icnTotal').textContent.replace('ë°•ìŠ¤','');
      const asg = $('asgTotal').textContent.replace('ë°•ìŠ¤','');
      const total = $('grandTotal').textContent.replace('ë°•ìŠ¤','');

      const submitTime = new Date();
      const submitTimeStr = `${submitTime.getFullYear()}-${String(submitTime.getMonth()+1).padStart(2,'0')}-${String(submitTime.getDate()).padStart(2,'0')} ${String(submitTime.getHours()).padStart(2,'0')}:${String(submitTime.getMinutes()).padStart(2,'0')}:${String(submitTime.getSeconds()).padStart(2,'0')}`;

      let orderNumber = $('orderNumber').value.trim();
      if (!orderNumber) {
        orderNumber = `F${String(submitTime.getMonth()+1).padStart(2,'0')}${String(submitTime.getDate()).padStart(2,'0')}-${String(submitTime.getHours()).padStart(2,'0')}${String(submitTime.getMinutes()).padStart(2,'0')}`;
        $('orderNumber').value = orderNumber;
      }

      const hasICN = Number(icn) > 0;
      const hasASG = Number(asg) > 0;
      let warehouse_tag = '';
      if (hasICN && hasASG) warehouse_tag = '[ICN+ASG]';
      else if (hasICN)      warehouse_tag = '[ICN]';
      else if (hasASG)      warehouse_tag = '[ASG]';

      const deliveryMethodVal = $('deliveryMethod').value;
      const requestTypeVal = (deliveryMethodVal === 'delivery' && hasASGSelected())
        ? ($('requestType').value || 'íŒ”ë ˆíŠ¸ ì¶œê³ ')
        : '';

      const combinedRequests = (deliveryMethodVal === 'delivery' && hasASGSelected())
        ? `ì¶œê³  ë°©ì‹: ${requestTypeVal}${$('requests').value ? '\\nì¶”ê°€ ìš”ì²­: ' + $('requests').value : ''}`
        : ($('requests').value || 'ì—†ìŒ');

      const adminSubject = `[í‘¸ë“œë¦¿ì§€] ${warehouse_tag ? warehouse_tag + ' ' : ''}ì‹ ê·œ ë°œì£¼ì„œ - ${orderNumber}`;
      const customerSubject = `[í‘¸ë“œë¦¿ì§€] ë°œì£¼ ì ‘ìˆ˜ í™•ì¸ - ${orderNumber}`;

      const params = {
        order_number: orderNumber,
        customer_type: $('customerType').value,
        company_name: $('companyName').value,
        contact_person: $('contactName').value,
        phone_number: $('contactPhone').value,
        customer_email: $('email').value,
        delivery_address: $('deliveryAddress').value,
        products: products.join('<br>'),
        icheon_quantity: icn,
        anseong_quantity: asg,
        total_quantity: total,
        delivery_method: deliveryMethodVal,
        delivery_date: $('deliveryDate').value,
        requests: `${combinedRequests}\n\n[ë°œì£¼ì„œ ì œì¶œì‹œê°„: ${submitTimeStr}]`,
        request_type: requestTypeVal,
        warehouse_tag,
        email_subject: adminSubject,
        customer_email_subject: customerSubject
      };

      params.__plain =
`[í‘¸ë“œë¦¿ì§€ ë°œì£¼ì„œ]
ë°œì£¼ë²ˆí˜¸: ${orderNumber}
ì œì¶œì‹œê°„: ${submitTimeStr}

íšŒì‚¬: ${params.company_name}
ë‹´ë‹¹: ${params.contact_person} / ${params.phone_number}
ì´ë©”ì¼: ${params.customer_email}
ì£¼ì†Œ: ${params.delivery_address}

ì œí’ˆ:
- ${products.join('\n- ')}

ì´ì²œ: ${icn}ë°•ìŠ¤, ì•ˆì„±: ${asg}ë°•ìŠ¤, ì´í•©: ${total}ë°•ìŠ¤
ë°°ì†¡ë°©ë²•: ${params.delivery_method}
í¬ë§ì¼: ${params.delivery_date}
${(deliveryMethodVal === 'delivery' && hasASGSelected()) ? `ì¶œê³  ë°©ì‹: ${requestTypeVal}\n` : ''}ìš”ì²­ì‚¬í•­: ${$('requests').value || 'ì—†ìŒ'}
(ì°¸ê³ ) ì°½ê³  íƒœê·¸: ${warehouse_tag}`;

      const btn = $('btnSubmit');
      const prev = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'ì „ì†¡ ì¤‘...';

      // ìˆ˜ì •ëœ ê³ ê°ìš© ë©”ì¼ ì „ì†¡ ë¶€ë¶„
      EmailClient.send(EMAILJS_SERVICE_ID, FOODRIDGE_TEMPLATE_ID, params)
        .then(() => {
          // ë°°ì†¡ ë°©ë²• í…ìŠ¤íŠ¸ ë³€í™˜
          const deliveryMethodText = $('deliveryMethod').value === 'delivery' ? 'ë°°ì†¡ ìš”ì²­' : 
                                    $('deliveryMethod').value === 'pickup' ? 'ì°½ê³  í”½ì—…' : 
                                    $('deliveryMethod').value;
          
          // ê³ ê°ìš© ë©”ì¼ íŒŒë¼ë¯¸í„°
          const customerEmailParams = {
            to_email: params.customer_email,
            company_name: params.company_name,
            contact_person: params.contact_person,
            products: params.products,
            total_quantity: params.total_quantity,
            delivery_method: deliveryMethodText,
            delivery_date: params.delivery_date,
            delivery_address: params.delivery_address,
            requests: params.requests || 'ì—†ìŒ',
            order_number: orderNumber,
            submit_time: submitTimeStr,
            email_subject: customerSubject
          };
          
          console.log('ê³ ê°ìš© ë©”ì¼ íŒŒë¼ë¯¸í„°:', customerEmailParams);
          
          return EmailClient.send(EMAILJS_SERVICE_ID, CUSTOMER_TEMPLATE_ID, customerEmailParams);
        })
        .then(() => {
          alert('ì œì¶œ ì™„ë£Œ! í‘¸ë“œë¦¿ì§€ ë‹´ë‹¹ìì—ê²Œ ë°œì£¼ì„œê°€ ì „ì†¡ë˜ì—ˆìœ¼ë©°, ê³ ê°ë‹˜ê»˜ ì ‘ìˆ˜ í™•ì¸ ë©”ì¼ì´ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
          $('orderForm').reset();
          $('orderNumber').value = generateOrderNumber();
          updateTotals();
        })
        .catch((err) => { 
          alert(`ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${err?.text || err?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`); 
        })
        .finally(() => { 
          btn.disabled = false; 
          btn.textContent = prev; 
        });
    }

    $('customerType').addEventListener('change', function() {
      const addr = $('deliveryAddress');
      if (this.value === 'existing-same') {
        addr.removeAttribute('required');
        $('addressGroup').style.opacity = 0.6;
      } else {
        addr.setAttribute('required', '');
        $('addressGroup').style.opacity = 1;
      }
    });

    window.addEventListener('DOMContentLoaded', () => {
      wireQtySync();
      applyASGStepSmart();
      updateTotals();
      toggleRequestType();
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') updateTotals();
      });
      $('deliveryMethod').addEventListener('change', toggleRequestType, {passive:true});
      $('btnReview').addEventListener('click', showOrderSummary, {passive: true});
      $('modalClose').addEventListener('click', closeModal, {passive: true});
      $('orderForm').addEventListener('submit', handleSubmit);
      $('orderModal').addEventListener('click', (e) => {
        if (e.target.id === 'orderModal') closeModal();
      }, {passive: true});
    });
  </script>
</body>
</html>
