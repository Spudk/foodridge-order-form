<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>푸드릿지 발주서</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 10px;
      -webkit-tap-highlight-color: transparent;
    }
    .container { max-width: 680px; margin: 0 auto; background: #fff; border-radius: 16px; box-shadow: 0 18px 36px rgba(0,0,0,.15); overflow: hidden; }
    .header { background: linear-gradient(135deg, #4CAF50 0%, #22c55e 100%); color:#fff; padding: 18px 20px; text-align:center; }
    .header h1 { font-size: 1.35rem; font-weight: 800; letter-spacing: .02em; }
    .content { padding: 18px; }
    .section { margin-bottom: 22px; }
    .section-title { font-size: 1.05rem; font-weight: 800; color:#0f172a; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #f1f5f9; }
    .form-group { margin-bottom: 12px; }
    .form-group label { display:block; font-size:.9rem; font-weight:700; color:#334155; margin-bottom:6px; }
    .form-group input, .form-group select, .form-group textarea {
      width:100%; padding:12px 14px; border:2px solid #e2e8f0; border-radius: 10px; font-size: 1rem; transition: box-shadow .2s, border-color .2s;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline:none; border-color:#22c55e; box-shadow: 0 0 0 4px rgba(34,197,94,.15);
    }
    .warehouse-section { background:#f8fafc; border:1px solid #e2e8f0; border-radius:12px; padding:12px; margin-bottom:10px; }
    .warehouse-title { font-weight:800; color:#0f172a; display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:8px; }
    .warehouse-code { font-size: .75rem; padding: 2px 8px; border-radius:9999px; background:#10b981; color:#fff; font-weight:800; }
    .product-item { display:flex; align-items:center; gap:10px; background:#fff; border-radius:10px; padding:10px; margin-top:8px; box-shadow: 0 1px 3px rgba(2,6,23,.06); }
    .product-item input[type="checkbox"] { width:22px; height:22px; accent-color:#22c55e; }
    .product-info { flex:1; min-width:0; }
    .product-code { font-size:.9rem; font-weight:900; color:#0f172a; }
    .product-name { font-size:.85rem; color:#475569; margin-top:2px; }
    .quantity { display:flex; align-items:center; gap:6px; }
    .quantity-input { width:90px; padding:10px 12px; text-align:center; border:2px solid #e2e8f0; border-radius:10px; font-size:1rem; }
    .summary-grid { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .summary-item { background:#f8fafc; border:1px solid #e2e8f0; border-radius:10px; padding:12px; text-align:center; }
    .summary-item .label { font-size:.8rem; color:#64748b; }
    .summary-item .value { font-size:1.25rem; font-weight:900; color:#0f172a; }
    .total-summary { grid-column: span 2; background:linear-gradient(135deg,#22c55e,#16a34a); color:#fff; border:none; }
    .total-summary .value { color:#fff; }
    .buttons { display:flex; gap:10px; margin-top:12px; }
    .btn { flex:1; padding:14px; border:none; border-radius:12px; font-weight:800; letter-spacing:.02em; cursor:pointer; box-shadow: 0 6px 14px rgba(2,6,23,.15); }
    .btn-secondary { background:#0ea5e9; color:#fff; }
    .btn-primary { background:#16a34a; color:#fff; }
    .required { color:#ef4444; }
    .delivery-notice { background:#fef3c7; border:1px solid #f59e0b; border-radius:10px; padding:12px; margin-top:12px; }
    .delivery-notice-icon { font-size:1.2rem; }
    .delivery-notice-title { font-weight:700; color:#92400e; font-size:.9rem; margin-bottom:6px; }
    .delivery-notice-content { color:#92400e; font-size:.85rem; line-height:1.4; }
    .modal { display:none; position:fixed; inset:0; z-index:1000; background:rgba(0,0,0,.5); }
    .modal-content { width:min(92%, 520px); max-height:82vh; overflow:auto; background:#fff; margin: 7vh auto; border-radius:16px; padding:18px; }
    .modal-header { display:flex; align-items:center; justify-content:space-between; padding-bottom:10px; border-bottom:1px solid #e2e8f0; }
    .close { font-size:28px; font-weight:800; color:#94a3b8; cursor:pointer; }
    @media (max-width:480px) {
      .container { border-radius: 0; }
      .buttons { flex-direction: column; }
      .summary-grid { grid-template-columns: 1fr; }
      .total-summary { grid-column: span 1; }
    }
    input, select, textarea { font-size:16px; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>🍽️ 푸드릿지 발주서</h1>
    </div>

    <div class="content">
      <form id="orderForm" novalidate>
        <!-- 기본 정보 -->
        <div class="section">
          <h3 class="section-title">📋 기본 정보</h3>

          <div class="form-group">
            <label>발주번호 (고객이 원할 경우 수정 가능)</label>
            <input type="text" id="orderNumber" placeholder="자동 생성됩니다">
          </div>

          <div class="form-group">
            <label>고객 유형 <span class="required">*</span></label>
            <select id="customerType" required>
              <option value="">선택하세요</option>
              <option value="existing-same">기존 고객 (기존 배송지)</option>
              <option value="existing-different">기존 고객 (다른 배송지)</option>
              <option value="new">신규 고객</option>
            </select>
          </div>

          <div class="form-group">
            <label>고객사명 <span class="required">*</span></label>
            <input type="text" id="companyName" required placeholder="회사명">
          </div>

          <div class="form-group">
            <label>담당자 이름 <span class="required">*</span></label>
            <input type="text" id="contactName" required placeholder="담당자명">
          </div>

          <div class="form-group">
            <label>연락처 <span class="required">*</span></label>
            <input type="tel" id="contactPhone" required placeholder="010-0000-0000">
          </div>

          <div class="form-group">
            <label>이메일 <span class="required">*</span></label>
            <input type="email" id="email" required placeholder="name@company.com">
          </div>

          <div class="form-group" id="addressGroup">
            <label>배송주소 <span class="required">*</span></label>
            <input type="text" id="deliveryAddress" required placeholder="시/군/구, 상세주소">
          </div>
        </div>

        <!-- 제품 선택 -->
        <div class="section">
          <h3 class="section-title">📦 제품 선택</h3>

          <!-- 이천 창고 -->
          <div class="warehouse-section">
            <div class="warehouse-title">
              <span>🏭 이천 창고 (캐나다 계란류) 부가세 면세 상품</span>
              <span class="warehouse-code">ICN</span>
            </div>

            <div class="product-item">
              <input type="checkbox" id="prod-5113">
              <div class="product-info">
                <div class="product-code">5113</div>
                <div class="product-name">캐나다 냉동 난백 2kg×6팩</div>
              </div>
              <div class="quantity">
                <input type="number" class="quantity-input" id="qty-5113" min="0" inputmode="numeric" placeholder="0">
                <span>박스</span>
              </div>
            </div>

            <div class="product-item">
              <input type="checkbox" id="prod-5313">
              <div class="product-info">
                <div class="product-code">5313</div>
                <div class="product-name">캐나다 냉동 전란 2kg×6팩</div>
              </div>
              <div class="quantity">
                <input type="number" class="quantity-input" id="qty-5313" min="0" inputmode="numeric" placeholder="0">
                <span>박스</span>
              </div>
            </div>

            <div class="product-item">
              <input type="checkbox" id="prod-5270">
              <div class="product-info">
                <div class="product-code">5270</div>
                <div class="product-name">캐나다 냉동 난황 2kg×6팩</div>
              </div>
              <div class="quantity">
                <input type="number" class="quantity-input" id="qty-5270" min="0" inputmode="numeric" placeholder="0">
                <span>박스</span>
              </div>
            </div>

            <div class="product-item">
              <input type="checkbox" id="prod-5139">
              <div class="product-info">
                <div class="product-code">5139</div>
                <div class="product-name">캐나다 냉동 슈퍼휩 1kg×12팩</div>
              </div>
              <div class="quantity">
                <input type="number" class="quantity-input" id="qty-5139" min="0" inputmode="numeric" placeholder="0">
                <span>박스</span>
              </div>
            </div>
          </div>

          <!-- 안성 창고 -->
          <div class="warehouse-section">
            <div class="warehouse-title">
              <span>🏭 안성 창고 (SQIZ 감자) 부가세 적용 상품</span>
              <span class="warehouse-code">ASG</span>
            </div>

            <div class="product-item">
              <input type="checkbox" id="prod-fr02001">
              <div class="product-info">
                <div class="product-code">FR02001</div>
                <div class="product-name">SQIZ 9MM 코팅 스킨오프 감자 2kg×6팩</div>
              </div>
              <div class="quantity">
                <input type="number" class="quantity-input" id="qty-fr02001" min="0" step="40" inputmode="numeric" placeholder="0 (↑ 40단위 / ↓ 1단위)">
                <span>박스</span>
              </div>
            </div>
          </div>
        </div>

        <!-- 주문 요약 -->
        <div class="section">
          <h3 class="section-title">📊 주문 요약</h3>
          <div class="summary-grid">
            <div class="summary-item">
              <div class="label">이천창고</div>
              <div class="value" id="icnTotal">0박스</div>
            </div>
            <div class="summary-item">
              <div class="label">안성창고</div>
              <div class="value" id="asgTotal">0박스</div>
            </div>
            <div class="summary-item total-summary">
              <div class="label">총 주문량</div>
              <div class="value" id="grandTotal">0박스</div>
            </div>
          </div>
        </div>

        <!-- 배송 정보 -->
        <div class="section">
          <h3 class="section-title">🚚 배송 정보</h3>

          <div class="form-group">
            <label>배송 방법 <span class="required">*</span></label>
            <select id="deliveryMethod" required>
              <option value="">선택하세요</option>
              <option value="delivery">배송 요청</option>
              <option value="pickup">창고 픽업</option>
            </select>
          </div>

          <div class="form-group">
            <label>배송요청일 또는 픽업희망일 <span class="required">*</span></label>
            <input type="date" id="deliveryDate" required>
          </div>

          <!-- 안성 + 배송요청일 때만 -->
          <div class="form-group hidden" id="requestTypeGroup">
            <label>출고 방식 (안성창고 + 배송 요청 시)</label>
            <select id="requestType">
              <option value="팔레트 출고" selected>팔레트 출고</option>
              <option value="수작업 출고">수작업 출고</option>
            </select>
          </div>

          <div class="form-group">
            <label>요청사항</label>
            <textarea id="requests" rows="2" placeholder="예: 10~12시 희망, 기사님 연락 요망 등"></textarea>
          </div>

          <div class="delivery-notice">
            <div style="display:flex; align-items:flex-start; gap:8px;">
              <span class="delivery-notice-icon">⚠️</span>
              <div>
                <div class="delivery-notice-title">배송 안내사항</div>
                <div class="delivery-notice-content">
                  • <strong>이천창고</strong>와 <strong>안성창고</strong> 제품은 <strong>합배송이 불가</strong>합니다.<br>
                  • 두 창고 제품을 함께 주문하실 경우 별도 배송됩니다.<br>
                  • 각각 MOQ를 유지해 주시기 바랍니다.
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="buttons">
          <button type="button" class="btn btn-secondary" id="btnReview">주문내용 확인</button>
          <button type="submit" class="btn btn-primary" id="btnSubmit">발주서 제출</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 모달 -->
  <div id="orderModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">📋 주문내용 확인</h3>
        <span class="close" id="modalClose" aria-label="닫기">&times;</span>
      </div>
      <div id="orderSummaryContent" style="line-height:1.6;"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <script>
    const EmailClient = {
      _ready:false,
      init(publicKey){
        try{
          if(window.emailjs && typeof window.emailjs.init === 'function'){
            window.emailjs.init(publicKey);
            this._ready = true;
          } else {
            console.warn('EmailJS not available; will fall back to mailto.');
          }
        }catch(e){ console.warn('EmailJS init failed:', e); }
      },
      send(serviceId, templateId, params){
        if(this._ready && window.emailjs && typeof window.emailjs.send === 'function'){
          return window.emailjs.send(serviceId, templateId, params);
        } else {
          const to = encodeURIComponent('order@foodridge.co.kr');
          const subject = encodeURIComponent('[푸드릿지] 신규 발주서 제출 - ' + (params.order_number || ''));
          const body = encodeURIComponent(params.__plain || '발주 내역이 첨부됩니다.');
          window.location.href = `mailto:${to}?subject=${subject}&body=${body}`;
          return Promise.resolve();
        }
      }
    };

    const EMAILJS_PUBLIC_KEY = "uShz4QaVUzFOJMOZs";
    const EMAILJS_SERVICE_ID = "service_24b5nff";
    const FOODRIDGE_TEMPLATE_ID = "template_4wmwxm2";
    const CUSTOMER_TEMPLATE_ID = "template_fg3wre7";
    EmailClient.init(EMAILJS_PUBLIC_KEY);

    const $ = (id) => document.getElementById(id);
    const todayISO = () => (new Date()).toISOString().split('T')[0];

    $('deliveryDate').min = todayISO();
    function generateOrderNumber() {
      const now = new Date();
      return `F${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}-${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;
    }
    $('orderNumber').value = generateOrderNumber();

    const ICN = ['5113','5313','5270','5139'];
    const ASG = ['fr02001'];

    function parseQty(v) {
      const n = parseInt(String(v).replace(/[^0-9]/g,''), 10);
      return isNaN(n) ? 0 : n;
    }

    function hasASGSelected(){
      return ASG.some(id => {
        const cb = $('prod-' + id);
        const qty = parseQty(($('qty-' + id) || {}).value);
        return cb && cb.checked && qty > 0;
      });
    }

    function updateTotals() {
      let icn = 0, asg = 0;
      ICN.forEach(id => {
        const cb = $('prod-' + id);
        const qty = parseQty(($('qty-' + id) || {}).value);
        if (cb && cb.checked && qty > 0) icn += qty;
      });
      ASG.forEach(id => {
        const cb = $('prod-' + id);
        const qty = parseQty(($('qty-' + id) || {}).value);
        if (cb && cb.checked && qty > 0) asg += qty;
      });
      $('icnTotal').textContent = icn + '박스';
      $('asgTotal').textContent = asg + '박스';
      $('grandTotal').textContent = (icn + asg) + '박스';
      toggleRequestType();
    }

    function wireQtySync() {
      const all = [...ICN, ...ASG];
      all.forEach(id => {
        const cb = $('prod-' + id);
        const qty = $('qty-' + id);
        if (!cb || !qty) return;

        cb.addEventListener('change', () => {
          if (cb.checked) {
            const isASG = ASG.includes(id);
            const defaultVal = isASG ? 40 : 1;
            if (!qty.value || parseQty(qty.value) === 0) qty.value = String(defaultVal);
          } else {
            qty.value = '';
          }
          updateTotals();
        }, {passive: true});

        const onQtyChange = () => {
          const val = parseQty(qty.value);
          cb.checked = val > 0;
          qty.value = val > 0 ? String(val) : '';
          updateTotals();
        };
        ['input','change','keyup','blur'].forEach(evt => qty.addEventListener(evt, onQtyChange, {passive:true}));
      });
    }

    function applyASGStepSmart() {
      ASG.forEach(id => {
        const qty = $('qty-' + id);
        if (!qty) return;

        qty.setAttribute('min','0');
        qty.setAttribute('step','40');
        qty.setAttribute('inputmode','numeric');
        qty.placeholder = '0 (↑ 40단위 / ↓ 1단위)';

        let last = parseQty(qty.value);

        qty.addEventListener('focus', () => { last = parseQty(qty.value); });

        qty.addEventListener('keydown', (e) => {
          let current = parseQty(qty.value);
          if (isNaN(current)) current = 0;

          if (e.key === 'ArrowUp') {
            e.preventDefault();
            const next = Math.max(40, (Math.floor(current / 40) + 1) * 40);
            qty.value = String(next);
            last = next;
            qty.dispatchEvent(new Event('input', {bubbles:true}));
          } else if (e.key === 'ArrowDown') {
            e.preventDefault();
            const next = Math.max(0, current - 1);
            qty.value = String(next);
            last = next;
            qty.dispatchEvent(new Event('input', {bubbles:true}));
          }
        });

        qty.addEventListener('input', (e) => {
          const inputType = e.inputType || '';
          const isTyping = inputType.startsWith('insertText') || inputType.startsWith('delete');

          let current = parseQty(qty.value);
          if (isTyping) {
            last = current;
            return;
          }

          if (current > last) {
            const snapped = Math.max(40, Math.ceil(current / 40) * 40);
            if (snapped !== current) {
              qty.value = String(snapped);
              current = snapped;
            }
          } else if (current < last) {
            const snapped = Math.max(0, last - 1);
            if (snapped !== current) {
              qty.value = String(snapped);
              current = snapped;
            }
          }
          last = current;
        });
      });
    }

    function toggleRequestType() {
      const dm = $('deliveryMethod').value;
      const group = $('requestTypeGroup');
      const sel = $('requestType');
      if (dm === 'delivery' && hasASGSelected()) {
        group.classList.remove('hidden');
        sel.value = '팔레트 출고';
      } else {
        group.classList.add('hidden');
        sel.value = '';
      }
    }

    function showOrderSummary() {
      let html = '';
      html += `<p><strong>발주번호:</strong> ${$('orderNumber').value || '자동 생성됩니다'}</p>`;
      html += `<p><strong>고객사:</strong> ${$('companyName').value}</p>`;
      html += `<p><strong>담당자:</strong> ${$('contactName').value}</p>`;
      html += `<p><strong>연락처:</strong> ${$('contactPhone').value}</p>`;
      html += `<p><strong>이메일:</strong> ${$('email').value}</p>`;
      html += `<p><strong>배송주소:</strong> ${$('deliveryAddress').value}</p>`;

      html += '<h4 style="margin:14px 0 6px; color:#16a34a">📦 선택 제품</h4>';
      const list = [];
      const P = [
        {id:'5113', name:'캐나다 냉동 난백 2kg×6팩', wh:'이천'},
        {id:'5313', name:'캐나다 냉동 전란 2kg×6팩', wh:'이천'},
        {id:'5270', name:'캐나다 냉동 난황 2kg×6팩', wh:'이천'},
        {id:'5139', name:'캐나다 냉동 슈퍼휩 1kg×12팩', wh:'이천'},
        {id:'fr02001', name:'SQIZ 9MM 코팅 스킨오프 감자 2kg×6팩', wh:'안성'}
      ];
      P.forEach(p => {
        const cb = $('prod-' + p.id);
        const q = parseQty(($('qty-' + p.id) || {}).value);
        if (cb && cb.checked && q > 0) {
          list.push(`• [${p.wh}] ${p.id} - ${p.name}: <strong>${q}박스</strong>`);
        }
      });
      html += list.length ? `<div>${list.join('<br>')}</div>` : `<p style="color:#ef4444">선택된 제품이 없습니다.</p>`;

      html += '<h4 style="margin:14px 0 6px; color:#16a34a">🚚 배송 정보</h4>';
      const dm = $('deliveryMethod');
      const dmText = dm.options[dm.selectedIndex]?.text || '미선택';
      html += `<p><strong>배송방법:</strong> ${dmText}</p>`;
      html += `<p><strong>희망일:</strong> ${$('deliveryDate').value || '미선택'}</p>`;
      if ($('deliveryMethod').value === 'delivery' && hasASGSelected()) {
        const rt = $('requestType').value || '팔레트 출고';
        html += `<p><strong>출고 방식:</strong> ${rt}</p>`;
      }
      if ($('requests').value) html += `<p><strong>요청사항:</strong> ${$('requests').value}</p>`;

      $('orderSummaryContent').innerHTML = html;
      $('orderModal').style.display = 'block';
    }

    function closeModal() { $('orderModal').style.display = 'none'; }

    function handleSubmit(e) {
      e.preventDefault();
      const required = ['customerType','companyName','contactName','contactPhone','email','deliveryAddress','deliveryMethod','deliveryDate'];
      let ok = true;
      required.forEach(id => {
        const el = $(id);
        if (!el || !String(el.value || '').trim()) {
          el && (el.style.borderColor = '#ef4444');
          ok = false;
        } else {
          el.style.borderColor = '#e2e8f0';
        }
      });

      const products = [];
      const P = [
        {id:'5113', label:'[이천] 5113 캐나다 냉동 난백 (2kg×6)'},
        {id:'5313', label:'[이천] 5313 캐나다 냉동 전란 (2kg×6)'},
        {id:'5270', label:'[이천] 5270 캐나다 냉동 난황 (2kg×6)'},
        {id:'5139', label:'[이천] 5139 캐나다 냉동 슈퍼휩 (1kg×12)'},
        {id:'fr02001', label:'[안성] FR02001 SQIZ 9MM 코팅 스킨오프 감자 (2kg×6)'}
      ];
      P.forEach(p => {
        const cb = $('prod-' + p.id);
        const q = parseQty(($('qty-' + p.id) || {}).value);
        if (cb && cb.checked && q > 0) products.push(`${p.label}: ${q}박스`);
      });
      if (!products.length) { alert('최소 1개 이상의 제품을 선택해주세요.'); ok = false; }
      if (!ok) { alert('필수 항목을 모두 입력해주세요.'); return; }

      const icn = $('icnTotal').textContent.replace('박스','');
      const asg = $('asgTotal').textContent.replace('박스','');
      const total = $('grandTotal').textContent.replace('박스','');

      const submitTime = new Date();
      const submitTimeStr = `${submitTime.getFullYear()}-${String(submitTime.getMonth()+1).padStart(2,'0')}-${String(submitTime.getDate()).padStart(2,'0')} ${String(submitTime.getHours()).padStart(2,'0')}:${String(submitTime.getMinutes()).padStart(2,'0')}:${String(submitTime.getSeconds()).padStart(2,'0')}`;

      let orderNumber = $('orderNumber').value.trim();
      if (!orderNumber) {
        orderNumber = `F${String(submitTime.getMonth()+1).padStart(2,'0')}${String(submitTime.getDate()).padStart(2,'0')}-${String(submitTime.getHours()).padStart(2,'0')}${String(submitTime.getMinutes()).padStart(2,'0')}`;
        $('orderNumber').value = orderNumber;
      }

      const hasICN = Number(icn) > 0;
      const hasASG = Number(asg) > 0;
      let warehouse_tag = '';
      if (hasICN && hasASG) warehouse_tag = '[ICN+ASG]';
      else if (hasICN)      warehouse_tag = '[ICN]';
      else if (hasASG)      warehouse_tag = '[ASG]';

      const deliveryMethodVal = $('deliveryMethod').value;
      const requestTypeVal = (deliveryMethodVal === 'delivery' && hasASGSelected())
        ? ($('requestType').value || '팔레트 출고')
        : '';

      const combinedRequests = (deliveryMethodVal === 'delivery' && hasASGSelected())
        ? `출고 방식: ${requestTypeVal}${$('requests').value ? '\\n추가 요청: ' + $('requests').value : ''}`
        : ($('requests').value || '없음');

      const adminSubject = `[푸드릿지] ${warehouse_tag ? warehouse_tag + ' ' : ''}신규 발주서 - ${orderNumber}`;
      const customerSubject = `[푸드릿지] 발주 접수 확인 - ${orderNumber}`;

      const params = {
        order_number: orderNumber,
        customer_type: $('customerType').value,
        company_name: $('companyName').value,
        contact_person: $('contactName').value,
        phone_number: $('contactPhone').value,
        customer_email: $('email').value,
        delivery_address: $('deliveryAddress').value,
        products: products.join('<br>'),
        icheon_quantity: icn,
        anseong_quantity: asg,
        total_quantity: total,
        delivery_method: deliveryMethodVal,
        delivery_date: $('deliveryDate').value,
        requests: `${combinedRequests}\n\n[발주서 제출시간: ${submitTimeStr}]`,
        request_type: requestTypeVal,
        warehouse_tag,
        email_subject: adminSubject,
        customer_email_subject: customerSubject
      };

      params.__plain =
`[푸드릿지 발주서]
발주번호: ${orderNumber}
제출시간: ${submitTimeStr}

회사: ${params.company_name}
담당: ${params.contact_person} / ${params.phone_number}
이메일: ${params.customer_email}
주소: ${params.delivery_address}

제품:
- ${products.join('\n- ')}

이천: ${icn}박스, 안성: ${asg}박스, 총합: ${total}박스
배송방법: ${params.delivery_method}
희망일: ${params.delivery_date}
${(deliveryMethodVal === 'delivery' && hasASGSelected()) ? `출고 방식: ${requestTypeVal}\n` : ''}요청사항: ${$('requests').value || '없음'}
(참고) 창고 태그: ${warehouse_tag}`;

      const btn = $('btnSubmit');
      const prev = btn.textContent;
      btn.disabled = true;
      btn.textContent = '전송 중...';

      // 수정된 고객용 메일 전송 부분
      EmailClient.send(EMAILJS_SERVICE_ID, FOODRIDGE_TEMPLATE_ID, params)
        .then(() => {
          // 배송 방법 텍스트 변환
          const deliveryMethodText = $('deliveryMethod').value === 'delivery' ? '배송 요청' : 
                                    $('deliveryMethod').value === 'pickup' ? '창고 픽업' : 
                                    $('deliveryMethod').value;
          
          // 고객용 메일 파라미터
          const customerEmailParams = {
            to_email: params.customer_email,
            company_name: params.company_name,
            contact_person: params.contact_person,
            products: params.products,
            total_quantity: params.total_quantity,
            delivery_method: deliveryMethodText,
            delivery_date: params.delivery_date,
            delivery_address: params.delivery_address,
            requests: params.requests || '없음',
            order_number: orderNumber,
            submit_time: submitTimeStr,
            email_subject: customerSubject
          };
          
          console.log('고객용 메일 파라미터:', customerEmailParams);
          
          return EmailClient.send(EMAILJS_SERVICE_ID, CUSTOMER_TEMPLATE_ID, customerEmailParams);
        })
        .then(() => {
          alert('제출 완료! 푸드릿지 담당자에게 발주서가 전송되었으며, 고객님께 접수 확인 메일이 발송되었습니다.');
          $('orderForm').reset();
          $('orderNumber').value = generateOrderNumber();
          updateTotals();
        })
        .catch((err) => { 
          alert(`전송 중 오류가 발생했습니다: ${err?.text || err?.message || '알 수 없는 오류'}`); 
        })
        .finally(() => { 
          btn.disabled = false; 
          btn.textContent = prev; 
        });
    }

    $('customerType').addEventListener('change', function() {
      const addr = $('deliveryAddress');
      if (this.value === 'existing-same') {
        addr.removeAttribute('required');
        $('addressGroup').style.opacity = 0.6;
      } else {
        addr.setAttribute('required', '');
        $('addressGroup').style.opacity = 1;
      }
    });

    window.addEventListener('DOMContentLoaded', () => {
      wireQtySync();
      applyASGStepSmart();
      updateTotals();
      toggleRequestType();
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') updateTotals();
      });
      $('deliveryMethod').addEventListener('change', toggleRequestType, {passive:true});
      $('btnReview').addEventListener('click', showOrderSummary, {passive: true});
      $('modalClose').addEventListener('click', closeModal, {passive: true});
      $('orderForm').addEventListener('submit', handleSubmit);
      $('orderModal').addEventListener('click', (e) => {
        if (e.target.id === 'orderModal') closeModal();
      }, {passive: true});
    });
  </script>
</body>
</html>
